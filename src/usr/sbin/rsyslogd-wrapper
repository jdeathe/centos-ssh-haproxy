#!/usr/bin/env bash

set -e

function __cleanup ()
{
	__delete_lock
}

function __create_lock ()
{
	if [[ -n ${lock_file} ]]
	then
		touch "${lock_file}"
	fi
}

function __delete_lock ()
{
	if [[ -e ${lock_file} ]]
	then
		rm -f "${lock_file}"
	fi
}

function __get_options ()
{
	local -r config_path="/etc/rsyslog.conf"
	local -r listen_address="127.0.0.1"

	local options="${1}"

	printf -- \
		'-n -4 -Q -l %s -f %s%s%s' \
		"${listen_address}" \
		"${config_path}" \
		"${options:+" "}" \
		"${options}"
}

function __get_rsyslogd_bin ()
{
	local -r bin_path="/usr/sbin/rsyslogd"

	if [[ -f ${bin_path} ]]
	then
		printf -- \
			'%s' \
			"${bin_path}"
	else
		printf -- \
			'%s' \
			"${bin_path##/usr}"
	fi
}

function main ()
{
	local -r bin="$(
		__get_rsyslogd_bin
	)"
	local -r bootstrap_state_file="/var/lib/misc/haproxy-bootstrap"
	local -r lock_file="/var/lock/subsys/rsyslogd-wrapper"
	local -r nice="/bin/nice"
	local -r niceness="10"

	local options
	local verbose="false"

	# Parse options
	while [[ "${#}" -gt 0 ]]
	do
		case "${1}" in
			-v|--verbose)
				verbose="true"
				shift 1
				;;
		esac
	done

	if [[ -e ${lock_file} ]]
	then
		>&2 printf -- \
			'ERROR: %s lock detected - aborting\n' \
			"${0##*/}"
		exit 1
	fi

	trap "__cleanup" \
		INT TERM EXIT
	__create_lock

	options="$(
		__get_options
	)"

	until [[ -e ${bootstrap_state_file} ]]
	do
		sleep 0.1
	done

	__cleanup
	trap - \
		INT TERM EXIT

	if [[ ${verbose} == true ]]
	then
		printf -- \
			'INFO: %s starting %s\n' \
			"${0##*/}" \
			"${bin##*/}"
	fi

	# Process via eval to allow for quoted option values.
	eval "exec ${nice} \
		-n ${niceness} \
		${bin} \
		${options}"
}

main "${@}"
