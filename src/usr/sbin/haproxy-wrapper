#!/usr/bin/env bash

readonly BIN="/usr/sbin/haproxy"
readonly CONFIG_PATH="/etc/haproxy/haproxy.cfg"
readonly LOCK_FILE="/var/lock/subsys/haproxy-bootstrap"
readonly NICE="/bin/nice"
readonly NICENESS="10"
readonly PID_PATH="/run/haproxy.pid"

OPTIONS="
 -W
 -f ${CONFIG_PATH}
 -p ${PID_PATH}
"

function __is_valid_configuration ()
{
	${BIN} \
		-c \
		-q \
		-f ${CONFIG_PATH}

	if [[ ${?} -ne 0 ]]
	then
		printf -- \
			'Errors in configuration file.\n' \
		>&2
		return 1
	fi

	return 0
}

while true
do
	sleep 0.1
	[[ -e ${LOCK_FILE} ]] || break
done

if ! __is_valid_configuration
then
	exit 1
else
	exec ${NICE} \
		-n ${NICENESS} \
		${BIN} \
		${OPTIONS}
fi
