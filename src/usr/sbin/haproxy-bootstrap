#!/usr/bin/env bash

readonly HAPROXY_SSL_CONFIG_PATH="/etc/pki/tls/certs/localhost.localdomain.cnf"
readonly HAPROXY_SSL_CERTIFICATE_PATH="/etc/pki/tls/certs/localhost.localdomain.crt"
readonly HAPROXY_CONFIG_PATH="/etc/haproxy/haproxy.cfg"

# Create lock file
touch /var/lock/subsys/haproxy-bootstrap

TIMER_START="$(
	date +%s.%N
)"

source /etc/haproxy-bootstrap.conf

function make_self_signed_san_certificate ()
{
	local CN
	local HOST
	local HOSTS="${@}"
	local SAN

	# Use default host if none specified.
	if [[ ${#HOSTS[@]} -eq 0 ]]; then
		HOSTS="localhost.localdomain"
	fi

	if [[ ${#HOSTS[@]} -gt 0 ]]; then
		for HOST in ${HOSTS[@]}; do
			if [[ -z ${SAN} ]]; then
				# Common Name is required - use the first host.
				CN="${HOST}"
			else
				# Additional hosts should be comma separated.
				SAN+=","
			fi

			# Build up the subjectAltName value.
			SAN+="DNS:${HOST}"
		done
	fi

	# Generate a custom openssl configuration - appending a san section.
	cat \
		/etc/pki/tls/openssl.cnf \
		- \
		<<-CONFIG > ${HAPROXY_SSL_CONFIG_PATH}

	[ san ]
	subjectAltName="${SAN:-root@localhost.localdomain}"
	CONFIG

	# Generate the certificate.
	openssl req \
		-x509 \
		-sha256 \
		-nodes \
		-newkey rsa:2048 \
		-days 365 \
		-reqexts san \
		-extensions san \
		-subj "/CN=${CN}" \
		-config ${HAPROXY_SSL_CONFIG_PATH} \
		-keyout ${HAPROXY_SSL_CERTIFICATE_PATH} \
		-out ${HAPROXY_SSL_CERTIFICATE_PATH}

}

function set_haproxy_certificate ()
{
	local -r pattern_base64='^[A-Za-z0-9/+=]*$'
	local -r pattern_plain_text='-----BEGIN PRIVATE KEY-----'

	local file_path=""
	local value="${1:-}"

	# Get value from file
	if [[ -n ${value} ]] \
		&& [[ -s ${value} ]]
	then
		file_path="${value}"
		value="$(
			cat "${value}"
		)"
	fi

	# Decode base64 encoded values
	if [[ -n ${value} ]] \
		&& [[ ! -s ${value} ]] \
		&& [[ ${value} =~ ${pattern_base64} ]]
	then
		value="$(
			base64 -d -i <<< "${value}"
		)"
		# Reset file path so unencoded value is written to container path
		if [[ -n ${file_path} ]] \
			&& [[ ${file_path} != ${HAPROXY_SSL_CERTIFICATE_PATH} ]]
		then
			file_path="${HAPROXY_SSL_CERTIFICATE_PATH}"
		fi
	fi

	if [[ -n ${value} ]] \
		&& [[ ! ${value} =~ ${pattern_plain_text} ]]
	then
		printf -- \
			'ERROR: Invalid HAPROXY_SSL_CERTIFICATE\n' \
			>&2
		sleep 0.1
		exit 1
	elif [[ -n ${value} ]] \
		&& [[ -n ${file_path} ]] \
		&& [[ ${file_path} != ${HAPROXY_SSL_CERTIFICATE_PATH} ]]
	then
		# Create a sym-link if value is defined in a file
		ln -sf \
			${file_path} \
			${HAPROXY_SSL_CERTIFICATE_PATH}
	elif [[ -n ${value} ]]
	then
		printf \
			-- '%s' \
			"${value}" \
		> ${HAPROXY_SSL_CERTIFICATE_PATH}
	fi

	if [[ ! -s ${HAPROXY_SSL_CERTIFICATE_PATH} ]]; then
		make_self_signed_san_certificate \
			"${HAPROXY_HOST_NAMES:-localhost.localdomain}" \
			&> /dev/null
	fi

	if [[ ! -s /etc/pki/tls/certs/sni/localhost.localdomain.crt ]]; then
		cp -pf \
			${HAPROXY_SSL_CERTIFICATE_PATH} \
			/etc/pki/tls/certs/sni/
	fi
}

function set_haproxy_config ()
{
	local -r pattern_base64='^[A-Za-z0-9/+=]*$'
	local -r pattern_plain_text='.* /var/lib/haproxy.*'

	local file_path=""
	local value="${1:-}"

	# Get value from file
	if [[ -n ${value} ]] \
		&& [[ -s ${value} ]]
	then
		file_path="${value}"
		value="$(
			cat "${value}"
		)"
	fi

	# Decode base64 encoded values
	if [[ -n ${value} ]] \
		&& [[ ! -s ${value} ]] \
		&& [[ ${value} =~ ${pattern_base64} ]]
	then
		value="$(
			base64 -d -i <<< "${value}"
		)"
		# Reset file path so unencoded value is written to container path
		if [[ -n ${file_path} ]] \
			&& [[ ${file_path} != ${HAPROXY_CONFIG_PATH} ]]
		then
			file_path="${HAPROXY_CONFIG_PATH}"
		fi
	fi

	if [[ -n ${value} ]] \
		&& [[ ! ${value} =~ ${pattern_plain_text} ]]
	then
		printf -- \
			'ERROR: Invalid HAPROXY_CONFIG\n' \
			>&2
		sleep 0.1
		exit 1
	elif [[ -n ${value} ]] \
		&& [[ -n ${file_path} ]] \
		&& [[ ${file_path} != ${HAPROXY_CONFIG_PATH} ]]
	then
		# Create a sym-link if value is defined in a file
		ln -sf \
			${file_path} \
			${HAPROXY_CONFIG_PATH}
	elif [[ -n ${value} ]]
	then
		printf \
			-- '%s' \
			"${value}" \
		> ${HAPROXY_CONFIG_PATH}
	fi
}

set_haproxy_certificate \
	"${HAPROXY_SSL_CERTIFICATE}"

set_haproxy_config \
	"${HAPROXY_CONFIG}"

TIMER_TOTAL="$(
	echo - | awk "\
	{ T1=\"${TIMER_START}\" } \
	{ T2=\"$(date +%s.%N)\" } \
	{ print T2 - T1; }"
)"

cat <<-EOT

	================================================================================
	HAProxy Details
	--------------------------------------------------------------------------------
	host names : ${HAPROXY_HOST_NAMES}
	
	$(haproxy -vv)
	--------------------------------------------------------------------------------
	${TIMER_TOTAL}

EOT

# Release lock file
rm -f /var/lock/subsys/haproxy-bootstrap

exit 0
